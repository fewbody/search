<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J60NE88WR1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J60NE88WR1');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nuclear Physics Research Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3a86ff;
            --secondary-color: #8338ec;
            --accent-color: #ff006e;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --light-gray: #e9ecef;
            --medium-gray: #dee2e6;
            --dark-gray: #6c757d;
            --message-user: #e3f2fd;
            --message-ai: #f0f4fc;
            --code-bg: #f1f3f5;
            --blockquote-bg: #f8f9fa;
            --blockquote-border: #dee2e6;
            --table-border: #dee2e6;
            --table-header-bg: #e9ecef;
            --header-height: 120px;
            --footer-height: 80px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            height: var(--header-height);
            display: flex;
            align-items: center;
        }
        
        .header-content {
            text-align: center;
            width: 100%;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }
        
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--header-height) - var(--footer-height));
            padding: 20px 0;
            overflow: hidden;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--card-color);
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            margin: 0 auto;
            width: 100%;
            max-width: 1000px;
            overflow: hidden;
            height: 100%;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            margin-bottom: 20px;
            max-width: 90%;
        }
        
        .message-user {
            align-self: flex-end;
            margin-left: auto;
            background-color: var(--message-user);
            border-radius: 18px 18px 0 18px;
            padding: 12px 16px;
        }
        
        .message-ai {
            align-self: flex-start;
            background-color: var(--message-ai);
            border-radius: 18px 18px 18px 0;
            padding: 12px 16px;
        }
        
        .message-content {
            line-height: 1.5;
            font-size: 1.05rem;
        }
        
        .message-time {
            font-size: 0.8rem;
            color: var(--dark-gray);
            margin-top: 5px;
            text-align: right;
        }
        
        .papers-section {
            margin-bottom: 25px;
            padding: 18px;
            background-color: rgba(58, 134, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(58, 134, 255, 0.2);
        }
        
        .papers-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }
        
        .papers-title:before {
            content: "ðŸ“š";
            margin-right: 8px;
        }
        
        .response-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--secondary-color);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }
        
        .response-title:before {
            content: "ðŸ¤–";
            margin-right: 8px;
        }
        
        .ai-response-section {
            margin-top: 20px;
        }
        
        .paper-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .paper-item {
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            background-color: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .paper-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .paper-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .paper-authors {
            font-size: 0.95rem;
            color: var(--dark-gray);
            margin-bottom: 8px;
        }
        
        .paper-link {
            display: inline-block;
            margin-top: 5px;
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .paper-link:hover {
            text-decoration: underline;
        }
        
        .chat-input-container {
            display: flex;
            padding: 15px;
            background-color: var(--light-gray);
            border-top: 1px solid var(--medium-gray);
            position: relative;
            z-index: 10;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--medium-gray);
            border-radius: 24px;
            font-size: 16px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.2);
        }
        
        .send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .send-button:hover {
            background-color: #2a75e6;
            transform: scale(1.05);
        }
        
        .settings-button {
            background-color: var(--dark-gray);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-button:hover {
            background-color: #5a6268;
        }
        
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .settings-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .settings-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-gray);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 16px;
        }
        
        .save-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .save-button:hover {
            background-color: #2a75e6;
        }
        
        .typing-indicator {
            padding: 10px 0;
            display: flex;
            align-items: center;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: var(--dark-gray);
            border-radius: 50%;
            opacity: 0.6;
            animation: typing 1.4s infinite both;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        
        footer {
            background-color: var(--text-color);
            color: white;
            padding: 15px 0;
            text-align: center;
            height: auto;
            min-height: var(--footer-height);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }
        
        .footer-content {
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
            line-height: 1.6;
            padding: 0 15px;
        }
        
        .footer-content a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .footer-content a:hover {
            text-decoration: underline;
        }
        
        .markdown h1 {
            font-size: 1.5rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        .markdown h2 {
            font-size: 1.3rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
        }
        
        .markdown h3 {
            font-size: 1.1rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--accent-color);
        }
        
        .markdown p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .markdown ul, .markdown ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            padding-left: 1rem;
        }
        
        .markdown li {
            margin-bottom: 0.5rem;
        }
        
        .markdown code {
            background-color: var(--code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: var(--accent-color);
        }
        
        .markdown pre {
            background-color: var(--code-bg);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1rem;
            border: 1px solid var(--medium-gray);
        }
        
        .markdown pre code {
            background-color: transparent;
            padding: 0;
            color: var(--text-color);
            font-size: 0.9em;
            display: block;
            line-height: 1.5;
        }
        
        .markdown blockquote {
            border-left: 4px solid var(--blockquote-border);
            background-color: var(--blockquote-bg);
            padding: 0.5rem 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: var(--dark-gray);
        }
        
        .markdown hr {
            border: 0;
            height: 1px;
            background-color: var(--medium-gray);
            margin: 1.5rem 0;
        }
        
        .markdown table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
            overflow-x: auto;
            display: block;
        }
        
        .markdown table th {
            background-color: var(--table-header-bg);
            border: 1px solid var(--table-border);
            padding: 0.5rem;
            text-align: left;
        }
        
        .markdown table td {
            border: 1px solid var(--table-border);
            padding: 0.5rem;
        }
        
        .markdown img {
            max-width: 100%;
            height: auto;
            margin: 1rem 0;
            border-radius: 4px;
        }
        
        .markdown a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .markdown a:hover {
            text-decoration: underline;
        }
        
        /* Mobile Responsive Fixes */
        @media (max-width: 768px) {
            /* Header fixes */
            :root {
                --header-height: 160px; /* Increase header height on mobile */
            }
            
            header {
                height: auto;
                min-height: var(--header-height);
                padding: 15px 10px;
            }
            
            .header-content {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8rem;
                margin-bottom: 10px;
                word-wrap: break-word;
            }
            
            .subtitle {
                font-size: 0.9rem;
                line-height: 1.4;
                padding: 0 5px;
            }
            
            /* Main content area fixes */
            main {
                height: calc(100vh - var(--header-height) - var(--footer-height));
                padding: 10px 0;
            }
            
            .container {
                padding: 5px;
            }
            
            .chat-container {
                margin: 0;
                border-radius: 8px;
            }
            
            .chat-messages {
                padding: 15px 10px;
            }
            
            .message {
                max-width: 95%;
                margin-bottom: 15px;
            }
            
            .message-content {
                font-size: 0.95rem;
                line-height: 1.4;
            }
            
            /* Chat input fixes */
            .chat-input-container {
                padding: 10px;
            }
            
            .chat-input {
                padding: 10px;
                font-size: 14px;
            }
            
            .send-button, .settings-button {
                width: 40px;
                height: 40px;
            }
            
            /* Footer fixes */
            footer {
                height: auto;
                min-height: var(--footer-height);
                padding: 10px;
            }
            
            .footer-content {
                font-size: 0.8rem;
                line-height: 1.4;
                padding: 0 5px;
            }
            
            /* Paper items fixes */
            .paper-item {
                padding: 12px;
            }
            
            .paper-title {
                font-size: 1rem;
            }
            
            .paper-authors {
                font-size: 0.85rem;
            }
            
            /* Settings modal fixes */
            .settings-content {
                width: 95%;
                padding: 15px;
            }
            
            .form-group input {
                padding: 8px 12px;
            }
        }
        
        /* Additional fixes for very small screens */
        @media (max-width: 380px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .subtitle {
                font-size: 0.8rem;
            }
            
            .message-content {
                font-size: 0.9rem;
            }
            
            .send-button, .settings-button {
                width: 36px;
                height: 36px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <h1>Nuclear Physics Research Assistant</h1>
                <p class="subtitle">Ask questions about nuclear theory and get AI-powered explanations with arXiv paper references</p>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message message-ai">
                    <div class="message-content">
                        Hello! I'm your Nuclear Physics Research Assistant. Ask me about any nuclear physics concept, method, or theory, and I'll provide an explanation along with relevant research papers. Try asking something like "What is CDCC method?" or "Explain nuclear shell model."
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" class="chat-input" placeholder="Ask about nuclear physics concepts..." autocomplete="off">
                <button id="send-button" class="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="settings-button" class="settings-button">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </main>

    <div id="settings-modal" class="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h2 class="settings-title">Settings</h2>
                <button id="close-settings" class="close-button">&times;</button>
            </div>
            <div class="form-group">
                <label for="api-key">DashScope API Key</label>
                <input type="password" id="api-key" placeholder="Enter your DashScope API key">
                <p style="font-size: 0.8rem; color: var(--dark-gray); margin-top: 5px;">
                    Your API key is stored securely in your browser's local storage.
                </p>
            </div>
            <div class="form-group">
                <label for="num-papers">Maximum papers to show</label>
                <input type="number" id="num-papers" value="5" min="1" max="20">
            </div>
            <button id="save-settings" class="save-button">Save Settings</button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>Designed and made by <a href="http://jinlei.fewbody.com/">Jin Lei</a>. Supported by the National Natural Science Foundation of China (Grants No. 12475132). If you find any bugs or errors related to this website, please <a href="mailto:jinl@tongji.edu.cn">email me</a>.</p>
        </div>
    </footer>

    <script>
        // Replace this line with your actual API key during build
        const API_KEY = "PLACEHOLDER";
        
        // DOM Elements
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettings = document.getElementById('close-settings');
        const saveSettings = document.getElementById('save-settings');
        const apiKeyInput = document.getElementById('api-key');
        const numPapersInput = document.getElementById('num-papers');
        
        // App state
        let isWaitingForResponse = false;
        let currentResponseElement = null;
        
        // Load settings from localStorage
        window.addEventListener('DOMContentLoaded', () => {
            const apiKey = localStorage.getItem('dashscope_api_key') || API_KEY;
            const numPapers = localStorage.getItem('num_papers') || '5';
            
            apiKeyInput.value = apiKey;
            numPapersInput.value = numPapers;
        });
        
        // Settings modal
        settingsButton.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });
        
        closeSettings.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });
        
        settingsModal.addEventListener('click', (event) => {
            if (event.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });
        
        saveSettings.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            const numPapers = numPapersInput.value;
            
            localStorage.setItem('dashscope_api_key', apiKey);
            localStorage.setItem('num_papers', numPapers);
            
            settingsModal.style.display = 'none';
        });
        
        // Send message on Enter press
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Send message on button click
        sendButton.addEventListener('click', sendMessage);
        
        // Show user message and get response
        function sendMessage() {
            const message = chatInput.value.trim();
            
            if (!message || isWaitingForResponse) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            
            // Clear input
            chatInput.value = '';
            
            // Get AI response
            getAIResponse(message);
        }
        
        // Add message to chat
        function addMessage(content, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = `message message-${sender}`;
            
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content markdown';
            contentElement.textContent = content;
            
            const timeElement = document.createElement('div');
            timeElement.className = 'message-time';
            timeElement.textContent = getFormattedTime();
            
            messageElement.appendChild(contentElement);
            messageElement.appendChild(timeElement);
            
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return contentElement;
        }
        
        // Create typing indicator
        function addTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.className = 'typing-indicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                typingElement.appendChild(dot);
            }
            
            chatMessages.appendChild(typingElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return typingElement;
        }
        
        // Format current time
        function getFormattedTime() {
            const now = new Date();
            let hours = now.getHours();
            let minutes = now.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            hours = hours % 12;
            hours = hours ? hours : 12;
            minutes = minutes < 10 ? '0' + minutes : minutes;
            
            return `${hours}:${minutes} ${ampm}`;
        }
        
        // Get AI response
        async function getAIResponse(userQuery) {
            // Check if API key is available
            const apiKey = localStorage.getItem('dashscope_api_key') || API_KEY;
            if (apiKey === "PLACEHOLDER" || !apiKey) {
                const contentElement = addMessage('Please set your DashScope API key in the settings before using the assistant.', 'ai');
                settingsButton.click();
                return;
            }
            
            // Add AI message placeholder with typing indicator
            const messageElement = document.createElement('div');
            messageElement.className = 'message message-ai';
            
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content markdown';
            contentElement.innerHTML = '';
            
            const timeElement = document.createElement('div');
            timeElement.className = 'message-time';
            timeElement.textContent = getFormattedTime();
            
            messageElement.appendChild(contentElement);
            messageElement.appendChild(timeElement);
            
            chatMessages.appendChild(messageElement);
            
            const typingIndicator = addTypingIndicator();
            
            // Set waiting state
            isWaitingForResponse = true;
            currentResponseElement = contentElement;
            
            // Disable input during response
            chatInput.disabled = true;
            sendButton.disabled = true;
            
            try {
                // First, search arXiv for relevant papers
                const papers = await searchArXivPapers(userQuery);
                
                // If papers were found, display them before the AI response
                if (papers.length > 0) {
                    // Remove typing indicator temporarily
                    typingIndicator.remove();
                    
                    // Create papers section at the beginning
                    const papersSection = document.createElement('div');
                    papersSection.className = 'papers-section';
                    
                    const papersTitle = document.createElement('div');
                    papersTitle.className = 'papers-title';
                    papersTitle.textContent = 'Relevant Papers Found';
                    
                    const papersList = document.createElement('div');
                    papersList.className = 'paper-list';
                    
                    papers.slice(0, parseInt(localStorage.getItem('num_papers') || '5')).forEach(paper => {
                        const paperItem = document.createElement('div');
                        paperItem.className = 'paper-item';
                        
                        const paperTitle = document.createElement('div');
                        paperTitle.className = 'paper-title';
                        paperTitle.textContent = paper.title;
                        
                        const paperAuthors = document.createElement('div');
                        paperAuthors.className = 'paper-authors';
                        paperAuthors.textContent = paper.authors.slice(0, 3).join(', ') + (paper.authors.length > 3 ? ', et al.' : '');
                        
                        const paperLink = document.createElement('a');
                        paperLink.className = 'paper-link';
                        paperLink.href = paper.link;
                        paperLink.target = '_blank';
                        paperLink.textContent = 'View on arXiv';
                        
                        paperItem.appendChild(paperTitle);
                        paperItem.appendChild(paperAuthors);
                        paperItem.appendChild(paperLink);
                        
                        papersList.appendChild(paperItem);
                    });
                    
                    papersSection.appendChild(papersTitle);
                    papersSection.appendChild(papersList);
                    
                    // Insert papers section at the beginning of the content
                    contentElement.appendChild(papersSection);
                    
                    // Create a separator and a placeholder for the AI response
                    const responseSection = document.createElement('div');
                    responseSection.className = 'ai-response-section';
                    responseSection.innerHTML = '<div class="response-title">Generating explanation...</div>';
                    contentElement.appendChild(responseSection);
                    
                    // Add typing indicator back after the papers section
                    chatMessages.appendChild(typingIndicator);
                    
                    // Scroll to show the papers
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Get LLM response using papers as context and append to response section
                    await streamLLMResponse(userQuery, papers, responseSection);
                } else {
                    // No papers found, just stream the response directly
                    typingIndicator.remove();
                    await streamLLMResponse(userQuery, [], contentElement);
                }
                
            } catch (error) {
                console.error('Error getting AI response:', error);
                contentElement.innerHTML = `Error: ${error.message}. Please try again.`;
                if (typingIndicator) typingIndicator.remove();
            } finally {
                // Reset state
                isWaitingForResponse = false;
                currentResponseElement = null;
                
                // Re-enable input
                chatInput.disabled = false;
                sendButton.disabled = false;
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // Search arXiv for relevant papers
        async function searchArXivPapers(query) {
            try {
                // Clean and format the query for arXiv API
                const formattedQuery = encodeURIComponent(query.replace(/[^\w\s]/gi, ' ').trim());
                
                // Call arXiv API
                const arxivUrl = `https://export.arxiv.org/api/query?search_query=cat:nucl-th+AND+all:${formattedQuery}&start=0&max_results=10&sortBy=relevance&sortOrder=descending`;
                
                const response = await fetch(arxivUrl);
                if (!response.ok) {
                    throw new Error(`ArXiv API error: ${response.status}`);
                }
                
                const data = await response.text();
                
                // Parse XML response
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data, "text/xml");
                const entries = xmlDoc.getElementsByTagName("entry");
                
                // Extract paper details
                const papers = [];
                for (let i = 0; i < entries.length; i++) {
                    const entry = entries[i];
                    
                    const title = entry.getElementsByTagName("title")[0].textContent;
                    const authors = Array.from(entry.getElementsByTagName("author")).map(
                        author => author.getElementsByTagName("name")[0].textContent
                    );
                    const abstract = entry.getElementsByTagName("summary")[0].textContent;
                    const link = Array.from(entry.getElementsByTagName("link")).find(
                        link => !link.getAttribute("title") || link.getAttribute("title") === "alternate"
                    ).getAttribute("href");
                    const arxivId = entry.getElementsByTagName("id")[0].textContent.split("/").pop();
                    
                    papers.push({
                        title,
                        authors,
                        abstract,
                        link,
                        arxivId
                    });
                }
                
                return papers;
                
            } catch (error) {
                console.error('Error fetching papers:', error);
                return [];
            }
        }
        
        // Stream response from LLM
        async function streamLLMResponse(query, papers, contentElement) {
            const apiKey = localStorage.getItem('dashscope_api_key') || API_KEY;
            
            // Build paper context
            let paperContext = '';
            if (papers.length > 0) {
                paperContext = 'Here are some relevant papers for context:\n\n';
                papers.slice(0, 3).forEach((paper, index) => {
                    paperContext += `Paper ${index + 1}: "${paper.title}" by ${paper.authors.slice(0, 2).join(', ')}\n`;
                    paperContext += `Abstract: ${paper.abstract}\n\n`;
                });
            }
            
            try {
                // If the content element is the response section, clear the "Generating explanation..." text
                if (contentElement.className === 'ai-response-section') {
                    contentElement.innerHTML = '<div class="response-title">AI Explanation:</div>';
                    
                    // Create a div to hold the streamed content
                    const responseContent = document.createElement('div');
                    responseContent.className = 'response-content markdown';
                    contentElement.appendChild(responseContent);
                    
                    // Update the reference for streaming
                    contentElement = responseContent;
                }
                
                // Setup LLM prompt with the papers as context
                const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "qwq-32b",
                        messages: [
                            {
                                role: "system",
                                content: "You are a helpful Nuclear Physics Research Assistant specializing in nuclear theory. Provide clear, concise, and accurate explanations about nuclear physics concepts, methods, and theories. Use markdown formatting for your response with appropriate headers, lists, emphasis, and code blocks where relevant. When mentioning specific papers, include citations in the format 'Author et al. (Year)' within your response."
                            },
                            {
                                role: "user",
                                content: `${query}\n\n${paperContext}`
                            }
                        ],
                        stream: true,
                        stream_options: {
                            include_usage: true
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API error: ${response.status} - ${errorText}`);
                }
                
                // Process streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            if (line.includes('[DONE]')) {
                                // End of stream
                                continue;
                            }
                            
                            try {
                                // Parse the JSON data
                                const jsonStr = line.substring(6); // Remove "data: " prefix
                                const data = JSON.parse(jsonStr);
                                
                                // Extract content from the delta
                                if (data.choices && 
                                    data.choices[0] && 
                                    data.choices[0].delta && 
                                    data.choices[0].delta.content) {
                                    
                                    const content = data.choices[0].delta.content;
                                    fullContent += content;
                                    
                                    // Update UI in real-time with formatted markdown
                                    contentElement.innerHTML = markdownToHtml(fullContent);
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            } catch (e) {
                                console.warn('Error parsing streaming chunk:', e);
                            }
                        }
                    }
                }
                
                // Final update in case we missed anything
                contentElement.innerHTML = markdownToHtml(fullContent);
                
            } catch (error) {
                console.error('Error streaming response:', error);
                throw error;
            }
        }
        
        // More robust markdown to HTML conversion
        function markdownToHtml(text) {
            if (!text) return '';
            
            // Process code blocks first (to avoid processing markdown inside them)
            const codeBlocks = [];
            text = text.replace(/```([a-z]*)\n([\s\S]*?)\n```/g, (match, language, code) => {
                const id = codeBlocks.length;
                codeBlocks.push(`<pre><code class="language-${language}">${escapeHtml(code)}</code></pre>`);
                return `__CODE_BLOCK_${id}__`;
            });
            
            // Process inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Headers
            text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // Bold and italic
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');
            
            // Blockquotes
            text = text.replace(/^\> (.+)$/gim, '<blockquote>$1</blockquote>');
            
            // Lists - improved handling for nested lists
            let inList = false;
            let listType = null;
            
            // Process ordered and unordered lists
            const lines = text.split('\n');
            for (let i = 0; i < lines.length; i++) {
                // Unordered lists
                if (lines[i].match(/^\s*[\-\*]\s+(.+)$/)) {
                    const content = lines[i].replace(/^\s*[\-\*]\s+(.+)$/, '$1');
                    
                    if (!inList || listType !== 'ul') {
                        // Start new list
                        lines[i] = inList ? '</ol><ul><li>' + content + '</li>' : '<ul><li>' + content + '</li>';
                        inList = true;
                        listType = 'ul';
                    } else {
                        // Continue list
                        lines[i] = '<li>' + content + '</li>';
                    }
                }
                // Ordered lists
                else if (lines[i].match(/^\s*\d+\.\s+(.+)$/)) {
                    const content = lines[i].replace(/^\s*\d+\.\s+(.+)$/, '$1');
                    
                    if (!inList || listType !== 'ol') {
                        // Start new list
                        lines[i] = inList ? '</ul><ol><li>' + content + '</li>' : '<ol><li>' + content + '</li>';
                        inList = true;
                        listType = 'ol';
                    } else {
                        // Continue list
                        lines[i] = '<li>' + content + '</li>';
                    }
                }
                // Close list if line is not a list item
                else if (inList && lines[i].trim() !== '') {
                    lines[i] = listType === 'ul' ? '</ul>' + lines[i] : '</ol>' + lines[i];
                    inList = false;
                    listType = null;
                }
            }
            
            // Close any open lists
            if (inList) {
                lines.push(listType === 'ul' ? '</ul>' : '</ol>');
            }
            
            text = lines.join('\n');
            
            // Links
            text = text.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Images
            text = text.replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1" style="max-width:100%;">');
            
            // Horizontal rule
            text = text.replace(/^\-{3,}$/gim, '<hr>');
            
            // Paragraphs
            text = text.replace(/\n\s*\n/g, '</p><p>');
            
            // Tables
            const tableRegex = /^\|(.+)\|$/gm;
            const headerRowRegex = /^\|((?:[-:]+\|)+)$/gm;
            
            if (text.match(tableRegex) && text.match(headerRowRegex)) {
                let inTable = false;
                const tableLines = text.split('\n');
                
                for (let i = 0; i < tableLines.length; i++) {
                    // Table header or content row
                    if (tableLines[i].match(/^\|(.+)\|$/)) {
                        // If it's a separator row (|---|---|)
                        if (tableLines[i].match(/^\|((?:[-:]+\|)+)$/)) {
                            tableLines[i] = ''; // Skip the separator row
                            continue;
                        }
                        
                        const cells = tableLines[i]
                            .replace(/^\||\|$/g, '') // Remove first and last pipe
                            .split('|')
                            .map(cell => cell.trim());
                        
                        if (!inTable) {
                            // Start new table with header row
                            tableLines[i] = '<table><thead><tr>' + 
                                cells.map(cell => `<th>${cell}</th>`).join('') + 
                                '</tr></thead><tbody>';
                            inTable = true;
                        } else {
                            // Add body row
                            tableLines[i] = '<tr>' + 
                                cells.map(cell => `<td>${cell}</td>`).join('') + 
                                '</tr>';
                        }
                    }
                    // End of table
                    else if (inTable && tableLines[i].trim() !== '') {
                        tableLines[i] = '</tbody></table>' + tableLines[i];
                        inTable = false;
                    }
                }
                
                // Close any open table
                if (inTable) {
                    tableLines.push('</tbody></table>');
                }
                
                text = tableLines.join('\n');
            }
            
            // Restore code blocks
            text = text.replace(/__CODE_BLOCK_(\d+)__/g, (match, id) => {
                return codeBlocks[parseInt(id)];
            });
            
            // Wrap in paragraph if it doesn't start with a block element
            if (!text.startsWith('<h') && !text.startsWith('<ul') && 
                !text.startsWith('<ol') && !text.startsWith('<blockquote') && 
                !text.startsWith('<pre') && !text.startsWith('<table')) {
                text = '<p>' + text + '</p>';
            }
            
            return text;
        }
        
        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    </script>
</body>
</html>
